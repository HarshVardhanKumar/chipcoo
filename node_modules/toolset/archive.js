var _ 					= require('underscore');
var fs 					= require('fs');
var archiver 			= require('archiver');
var unzip 				= require('unzip');
var file 				= require('./file').main;
var path 				= require('path');
var tar 				= require("tar-fixed");
var fstream 			= require("fstream");

function archive() {
	
}

archive.prototype.compressDirectory = function(directory, filename, callback) {
	
	var output = fs.createWriteStream(filename);
	
	output.on('close', function() {
		callback(filename);
	});
	
	output.on('error', function(err) {
		throw err;
	});
	
	output.on('open', function(err) {
		fstream.Reader({ path: directory, type: "Directory" }).pipe(tar.Pack({ noProprietary: true })).pipe(output);
	});
	
	
	/*
	var output 		= fs.createWriteStream(filename);
	var archive 	= archiver('zip');
	
	output.on('close', function() {
		console.log(archive.pointer() + ' total bytes');
		callback(filename);
	});
	
	archive.on('error', function(err) {
		throw err;
	});
	
	archive.pipe(output);
	
	// Get the list of files
	file.listFiles(directory, false, function(files) {
		_.each(files, function(file) {
			archive.append(fs.createReadStream(file), {
				name: 	path.basename(file)
			});
		});
		archive.finalize();
	});*/
}
archive.prototype.extract = function(filename, directory, callback) {
	var input = fs.createReadStream(filename);
	
	var tarInstance = tar.Extract({ path: directory });
	
	input.pipe(tarInstance);
	
	tarInstance.on("error", function (err) {
		throw err;
	});
	
	tarInstance.on("end", function () {
		callback();
		console.error("done")
	});
	
	/*
	var extractor = unzip.Extract({ path: directory });
	
	fs.createReadStream(filename).pipe(extractor);
	
	extractor.on('error', function(err) {
		throw err;
	});
	extractor.on('close', callback);
	*/
}

exports.main = new archive();